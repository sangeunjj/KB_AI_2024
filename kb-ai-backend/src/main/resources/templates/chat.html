<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/chat.css">
    <title>Chat Page</title>
</head>
<body>
<div class="sidebar active" id="sidebar">
    <div class="profile">
        <!-- Gender가 1인 경우 -->
        <img class="profile-image" th:if="${session.member?.gender == 1}" th:src="@{/icons/men.png}" alt="Profile Picture">
        <!-- Gender가 2인 경우 -->
        <img class="profile-image" th:if="${session.member?.gender == 2}" th:src="@{/icons/women.png}" alt="Profile Picture">
        <!-- 로그인하지 않은 경우 또는 다른 값인 경우 -->
        <img class="profile-image" th:if="${session.member?.gender != 1 and session.member?.gender != 2}" th:src="@{/icons/default-profile1.png}" alt="Profile Picture">

        <span id="username" th:text="${session.member?.username ?: '익명'}">김대리</span>
    </div>
    <div class="menu-items">
        <a href="/"><img src="/icons/chat2.png" alt="Chat Icon" class="icon" width="25px" height="25px">Chat</a>
        <a href="/company"><img src="/icons/company2.png" alt="Company Icon" class="icon" width="25px" height="25px">Company</a>
        <a href="/report1"><img src="/icons/report9.png" alt="Report Icon" class="icon" width="25px" height="25px">Report</a>
    </div>
    <div class="auth">
        <a th:if="${session.member}" href="/logout"><img src="/icons/logout1.png" alt="Logout Icon" class="icon" width="25px" height="25px">Log Out</a>
        <a th:unless="${session.member}" href="/login"><img src="/icons/login.png" alt="Login Icon" class="icon" width="25px" height="25px">Log In</a>
    </div>
</div>
<div class="content expanded" id="content">
    <div class="navbar">
        <div class="left-section">
            <div class="toggle-btn" onclick="toggleSidebar()">☰</div>
            <div class="logo">KB <span>ANALYSIS</span></div>
        </div>
        <div class="search-container">
            <input type="text" placeholder="기업명을 입력하세요">
            <button class="search-clear">X</button>
        </div>
    </div>
    <div class="main-content">
        <div class="chat-container">
            <div class="chat-box" id="chat-box">
                <div class="message user-message">
                    사용자 질문 내용이 여기에 표시됩니다.
                </div>
                <div class="message bot-message">
                    <img src="/images/kb-logo.png" alt="Bot Profile Image">
                    <span>GPT 응답 내용이 여기에 표시됩니다.</span>
                </div>
            </div>
        </div>
        <div class="input-container">
            <textarea id="user-input" placeholder="질문을 입력하세요..." rows="1" oninput="autoGrow(this)"></textarea>
            <button onclick="sendMessage()">
                <img src="/icons/send2.png" alt="전송 버튼" class="rotated-image">
            </button>
        </div>
    </div>
</div>
<script th:src="@{/js/navbar.js}"></script>
<script>
    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const content = document.getElementById("content");
        sidebar.classList.toggle("active");
        content.classList.toggle("expanded");
    }

    document.querySelector('.search-clear').addEventListener('click', function () {
        document.querySelector('.search-container input').value = '';
    });

    function sendMessage() {
        const userInput = document.getElementById('user-input');
        const chatBox = document.getElementById('chat-box');
        const message = userInput.value.trim();

        if (message) {
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user-message');
            userMessage.textContent = message;
            chatBox.appendChild(userMessage);

            chatBox.scrollTop = chatBox.scrollHeight;

            userInput.value = '';

            const botMessage = document.createElement('div');
            botMessage.classList.add('message', 'bot-message');
            const botImage = document.createElement('img');
            botImage.src = "/images/kb-logo.png";
            botImage.alt = "Bot Profile Image";
            botMessage.appendChild(botImage);
            const botText = document.createElement('span');
            botText.textContent = '여기에 GPT 응답이 표시됩니다.';
            botMessage.appendChild(botText);
            chatBox.appendChild(botMessage);

            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }

    document.getElementById('user-input').addEventListener('keypress', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // 기본 동작(줄바꿈) 방지
            sendMessage();
        }
    });

    function autoGrow(element) {
        element.style.height = "auto"; // 초기 높이를 자동으로 설정
        const maxHeight = parseInt(window.getComputedStyle(element).lineHeight) * 5; // 최대 5줄 높이 설정
        element.style.height = Math.min(element.scrollHeight, maxHeight) + "px";

        if (element.scrollHeight > maxHeight) {
            element.style.overflowY = "scroll"; // 스크롤 활성화
        } else {
            element.style.overflowY = "hidden"; // 스크롤 비활성화
        }

        // 부모 요소의 높이를 입력 칸의 높이에 맞춰 조정
        const parent = element.parentElement;
        parent.style.height = element.style.height;

        // 입력란이 위로 확장되도록 스크롤 위치 조정
        const chatContainer = document.querySelector('.chat-container');
        chatContainer.scrollTop = chatContainer.scrollHeight - chatContainer.clientHeight;
    }
</script>
</body>
</html>